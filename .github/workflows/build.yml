name: Build Chromium Windows
on:
  workflow_dispatch:
env:
  CHROMIUM_VERSION: 144.0.7548.0
  DEPOT_TOOLS_WIN_TOOLCHAIN: 0
jobs:
  build:
    runs-on: windows-2022
    timeout-minutes: 360
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Enable long paths
        shell: pwsh
        run: git config --system core.longpaths true
      - name: Fetch Chromium source
        shell: pwsh
        run: |
          .\scripts\fetch_chromium.ps1 -Version $env:CHROMIUM_VERSION
          $depotToolsPath = Join-Path $PWD "depot_tools"
          if (-not (Test-Path $depotToolsPath)) { throw "depot_tools directory was not created." }
          $depotToolsPath | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      - name: Generate build files and compile
        shell: pwsh
        run: |
          $vsDevCmdCandidates = @(
            "${env:ProgramFiles(x86)}\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\VsDevCmd.bat",
            "${env:ProgramFiles(x86)}\Microsoft Visual Studio\2022\Professional\Common7\Tools\VsDevCmd.bat",
            "${env:ProgramFiles(x86)}\Microsoft Visual Studio\2022\Community\Common7\Tools\VsDevCmd.bat",
            "${env:ProgramFiles(x86)}\Microsoft Visual Studio\2022\BuildTools\Common7\Tools\VsDevCmd.bat"
          )
          $vsDevCmd = $vsDevCmdCandidates | Where-Object { Test-Path $_ } | Select-Object -First 1
          if (-not $vsDevCmd) { throw "Unable to locate VsDevCmd.bat for Visual Studio 2022." }
          $gnArgs = (Get-Content "$env:GITHUB_WORKSPACE\config\gn_args.win" -Raw).Replace("`r"," ").Replace("`n"," ")
          $cmdLines = @(
            "`"$vsDevCmd`"",
            "set DEPOT_TOOLS_WIN_TOOLCHAIN=0",
            "set ""PATH=$env:GITHUB_WORKSPACE\depot_tools;%PATH%""",
            "cd /d $env:GITHUB_WORKSPACE\src",
            "gn gen out\Release --args=""$gnArgs""",
            "autoninja -C out\Release chrome"
          )
          $command = $cmdLines -join " && "
          cmd.exe /c $command
      - name: Package release archive
        shell: pwsh
        run: |
          $archivePath = Join-Path $env:GITHUB_WORKSPACE "chromium-win-release.zip"
          if (Test-Path $archivePath) { Remove-Item $archivePath -Force }
          Compress-Archive -Path "$env:GITHUB_WORKSPACE\src\out\Release\*" -DestinationPath $archivePath
      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: chromium-win-release
          path: chromium-win-release.zip
          if-no-files-found: error
      - name: Compute release metadata
        id: release_meta
        shell: pwsh
        run: |
          $tag = "chromium-$env:CHROMIUM_VERSION-build-$env:GITHUB_RUN_NUMBER"
          $name = "Chromium $env:CHROMIUM_VERSION Windows build #$env:GITHUB_RUN_NUMBER"
          "tag=$tag" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "name=$name" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
      - name: Create GitHub release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.release_meta.outputs.tag }}
          release_name: ${{ steps.release_meta.outputs.name }}
          draft: false
          prerelease: false
          body: >
            Automated build of Chromium ${{ env.CHROMIUM_VERSION }} for Windows. Triggered from workflow run ${{ github.run_id }}.
      - name: Upload release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: chromium-win-release.zip
          asset_name: chromium-win-release.zip
          asset_content_type: application/zip

